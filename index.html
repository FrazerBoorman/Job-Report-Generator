<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Report Generator</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Your OAuth client ID -->
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />
  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.40);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 26px;
      letter-spacing: .02em;
    }
    .muted { color: var(--muted); font-size: 14px; }
    .pill {
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;padding:3px 9px;border-radius:999px;
      border:1px solid var(--border);color:var(--muted);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display:block;
    }
    input, select, textarea {
      width: 100%;
      font-size: 14px;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      resize: vertical;
    }
    textarea { min-height: 60px; }
    input::placeholder, textarea::placeholder { color: var(--muted); }

    .btn-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 13px;
      font-size: 14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: var(--panel);
      color: var(--text);
      cursor:pointer;
      transition: transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    button.primary {
      border-color: var(--accent);
      background: linear-gradient(180deg, var(--accent-soft), transparent);
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15,23,42,0.5); }

    .section {
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.6);
      border: 1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background: #f9fafb; }
    }
    .section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; }

    details.contacts { margin-top:6px; }
    details.contacts summary {
      cursor:pointer;
      font-size: 13px;
      color: var(--muted);
    }

    .small-note { font-size: 11px; color: var(--muted); margin-top: 3px; }

    #reportPreview {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px;
      background: var(--panel);
      max-height: 420px;
      overflow: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    #reportPreview h1 { font-size: 16px; margin: 0 0 6px; }
    #reportPreview h2 { font-size: 14px; margin: 8px 0 4px; }
    #reportPreview p { margin: 2px 0 6px; }
    #reportPreview table { border-collapse: collapse; width: 100%; margin: 4px 0 8px; }
    #reportPreview th, #reportPreview td {
      border: 1px solid var(--border);
      padding: 4px 6px;
      font-size: 12px;
      vertical-align: top;
    }

    .file-list { font-size: 12px; color: var(--muted); margin-top:4px; }

    .warning { color: var(--danger); font-size: 12px; margin-top: 4px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
        <div>
          <h1>Job Report Generator</h1>
          <div class="muted">Automatically pull the last 10 jobs from Google Calendar, scalp with AI, and generate a Word report.</div>
        </div>
        <span class="pill">Frazer · AVD Tools</span>
      </div>

      <!-- Calendar selection -->
      <div class="section" id="calendarSection">
        <div class="section-title">Step 1 – Recent jobs from calendar</div>
        <div class="grid">
          <div>
            <label for="calendarId">Calendar ID</label>
            <input id="calendarId"
              value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
            <div class="small-note">Used to load your last 10 past events automatically.</div>
          </div>
          <div>
            <label for="eventSelect">Recent events (last 10 past)</label>
            <select id="eventSelect">
              <option value="">Loading…</option>
            </select>
            <div id="authStatus" class="small-note">Status: Initialising…</div>
            <div id="aiStatus" class="small-note"></div>
          </div>
          <div style="align-self:end;">
            <!-- Keep sign-in button as manual fallback if auto fails -->
            <button id="signinBtn" type="button">Re-sign into Google</button>
            <div class="small-note">Normally signs in & loads events automatically.</div>
          </div>
        </div>
      </div>

      <!-- Report fields -->
      <div class="section">
        <div class="section-title">Step 2 – Job details</div>
        <div class="grid">
          <div>
            <label for="employee">Employee</label>
            <input id="employee" placeholder="Derived from calendar ID if possible" />
          </div>
          <div>
            <label for="jobType">Job type</label>
            <select id="jobType">
              <option value="">— Select job type —</option>
              <option value="TCO">TCO (Technical Call Out)</option>
              <option value="RTF">RTF (Return To Fix)</option>
              <option value="Meeting / Consultation">Meeting / Consultation</option>
              <option value="Recce">Recce</option>
              <option value="Job / Installation">Job / Installation</option>
            </select>
            <div class="small-note">AI will set this if it can. Otherwise you choose.</div>
          </div>
          <div>
            <label for="jobDate">Job date</label>
            <input id="jobDate" type="date" />
          </div>
          <div>
            <label for="jobAddress">Address / site</label>
            <input id="jobAddress" placeholder="From title, location, or description" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="jobDescription">Job description</label>
          <textarea id="jobDescription"
            placeholder="Summary of what you were supposed to do. AI fills from event."></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="techCheck">Tech check summary</label>
          <textarea id="techCheck"
            placeholder="TECH CHECK notes or similar from the event/linked docs."></textarea>
          <div id="techLinks" class="small-note"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Step 3 – People & time on site</div>
        <div class="grid">
          <div>
            <label for="personsMet">Person(s) met</label>
            <input id="personsMet" placeholder="Name(s) of contact(s) on site" />
          </div>
        </div>

        <details class="contacts">
          <summary>Contact details (optional)</summary>
          <div class="grid" style="margin-top:6px;">
            <div>
              <label for="contactPhone">Phone</label>
              <input id="contactPhone" />
            </div>
            <div>
              <label for="contactEmail">Email</label>
              <input id="contactEmail" />
            </div>
            <div>
              <label for="contactAddress">Postal address (if office need to post something)</label>
              <textarea id="contactAddress"></textarea>
            </div>
          </div>
        </details>

        <div id="timeOnSiteBlock" style="margin-top:10px; display:none;">
          <label>Time on site (for TCO/RTF)</label>
          <div class="row">
            <div style="flex:1 1 160px;">
              <label for="timeArrived" style="font-weight:500;font-size:12px;">Arrived</label>
              <input id="timeArrived" type="time" />
            </div>
            <div style="flex:1 1 160px;">
              <label for="timeLeft" style="font-weight:500;font-size:12px;">Left</label>
              <input id="timeLeft" type="time" />
            </div>
            <div style="flex:1 1 200px;">
              <label style="font-weight:500;font-size:12px;">Duration</label>
              <input id="timeDuration" readonly />
            </div>
          </div>
          <div class="small-note">Ignored for Job / Installation unless you want to note it.</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Step 4 – Findings & advisories</div>
        <div class="grid">
          <div>
            <label for="findings">Findings</label>
            <textarea id="findings"
              placeholder="Short, brief sentences describing what you found."></textarea>
          </div>
          <div>
            <label for="howLeft">How things have been left</label>
            <textarea id="howLeft"
              placeholder="Short bullet-style notes. These get turned into a paragraph in the report."></textarea>
          </div>
        </div>
        <div style="margin-top:10px;">
          <label for="advisories">Advisories</label>
          <textarea id="advisories"
            placeholder="More short notes (e.g. future improvements, risks). Also turned into proper sentences in the report."></textarea>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Step 5 – Photos / videos</div>
        <div>
          <label for="mediaFiles">Upload photos / videos</label>
          <input id="mediaFiles" type="file" accept="image/*,video/*" multiple />
          <div class="small-note">Files are only kept locally in your browser. They can’t be emailed automatically from here, but they’ll be listed in the report so you know what to attach.</div>
          <div id="mediaList" class="file-list"></div>
        </div>
      </div>

      <!-- Actions & preview -->
      <div class="section">
        <div class="section-title">Step 6 – Generate, check & send</div>
        <div class="btn-row">
          <button id="generateBtn" class="primary" type="button">Generate report</button>
          <button id="viewBtn" type="button">View report</button>
          <button id="copyBtn" type="button">Copy report text</button>
          <button id="downloadDocBtn" type="button">Download Word (.doc)</button>
          <button id="sendBtn" type="button">Send (opens email)</button>
        </div>
        <div class="small-note">Send opens your email client with the report text prefilled to Neil, Mark &amp; David. Attach photos/videos and the .doc manually.</div>

        <div style="margin-top:10px;">
          <label>Report preview</label>
          <div id="reportPreview">No report generated yet.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======================
    //  CONFIG / CONSTANTS
    // ======================
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES   = "https://www.googleapis.com/auth/calendar.readonly";
    const OPENAI_MODEL = "gpt-4.1-mini";
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key"; // set via console once

    // To set your OpenAI key once, open browser console on this page and run:
    // localStorage.setItem('avd_job_report_openai_key', 'sk-XXXX...');

    let accessToken = null;
    let tokenClient = null;
    let currentEvents = [];
    let lastReportText = "";

    function setStatus(msg, ok) {
      const el = document.getElementById("authStatus");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.style.color = ok === false ? "var(--danger)" : "";
    }

    function setAiStatus(msg, ok) {
      const el = document.getElementById("aiStatus");
      if (!el) return;
      el.textContent = msg;
      el.style.color = ok === false ? "var(--danger)" : "";
    }

    // ======================
    //  GOOGLE AUTH & EVENTS
    // ======================
    function initAuth() {
      if (!window.google || !google.accounts || !google.accounts.oauth2) return;
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: "",
        callback: function(resp) {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in to Google.", true);
            loadRecentEvents(); // auto load most recent 10 past events
          } else {
            setStatus("Sign-in failed.", false);
          }
        }
      });
    }

    function signInManual() {
      if (!tokenClient) initAuth();
      if (!tokenClient) {
        setStatus("Google auth not ready.", false);
        return;
      }
      tokenClient.requestAccessToken();
    }

    function getEventStartDate(ev) {
      if (!ev || !ev.start) return null;
      if (ev.start.date) return new Date(ev.start.date + "T00:00:00Z");
      if (ev.start.dateTime) return new Date(ev.start.dateTime);
      return null;
    }

    function extractPrimaryDate(ev) {
      if (!ev || !ev.start) return "";
      if (ev.start.date) return ev.start.date;
      if (ev.start.dateTime) return ev.start.dateTime.slice(0, 10);
      return "";
    }

    async function loadRecentEvents() {
  if (!accessToken) {
    setStatus("No access token yet.", false);
    return;
  }

  const calId = (document.getElementById("calendarId").value || "primary").trim();

  // We only want events from the last 14 days up to the end of today
  const now = new Date();

  const end = new Date(now);
  end.setHours(23, 59, 59, 999);

  const start = new Date(now);
  start.setDate(start.getDate() - 14);
  start.setHours(0, 0, 0, 0);

  const url = new URL(
    "https://www.googleapis.com/calendar/v3/calendars/" +
    encodeURIComponent(calId) +
    "/events"
  );

  url.searchParams.set("singleEvents", "true");
  url.searchParams.set("orderBy", "startTime");
  url.searchParams.set("timeMin", start.toISOString());
  url.searchParams.set("timeMax", end.toISOString());
  url.searchParams.set("maxResults", "250"); // plenty for 14 days

  const res = await fetch(url.toString(), {
    headers: { "Authorization": "Bearer " + accessToken }
  });

  if (!res.ok) {
    setStatus("Calendar API error " + res.status, false);
    return;
  }

  const data = await res.json();
  const all = data.items || [];

  // Sort by startDate DESC so the newest appears first
  const nowRef = new Date();
  const processed = all
    .map(function (ev) {
      return { ev: ev, startDate: getEventStartDate(ev) };
    })
    .filter(function (obj) {
      return obj.startDate && obj.startDate <= nowRef;
    })
    .sort(function (a, b) {
      return b.startDate - a.startDate; // newest first
    });

  const picked = processed.map(function (x) { return x.ev; });

  currentEvents = picked;

  const sel = document.getElementById("eventSelect");
  sel.innerHTML = "";

  if (!picked.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No events in the last 14 days.";
    sel.appendChild(opt);
    setStatus("No events in the last 14 days.", false);
    return;
  }

  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "— Select job —";
  sel.appendChild(placeholder);

  for (let i = 0; i < picked.length; i++) {
    const ev = picked[i];
    const title = ev.summary || "(no title)";
    const d = extractPrimaryDate(ev);
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = (d ? (d + " – ") : "") + title;
    sel.appendChild(opt);
  }

  setStatus("Loaded " + picked.length + " events from last 14 days.", true);
  deriveEmployeeFromCalendarId(calId);

  // Automatically select the most recent and run AI scalp
  if (picked.length > 0) {
    sel.selectedIndex = 1; // first real event
    aiParseSelectedEvent();
  }
}

      if (!res.ok) {
        setStatus("Calendar API error " + res.status, false);
        return;
      }
      const data = await res.json();
      const all = data.items || [];

      // Filter to events whose start < now, sort descending, take 10
      const past = all
        .map(function(ev) {
          return { ev: ev, startDate: getEventStartDate(ev) };
        })
        .filter(function(obj) {
          return obj.startDate && obj.startDate <= now;
        })
        .sort(function(a, b) {
          return b.startDate - a.startDate; // newest first
        });

      const picked = past.slice(0, 10).map(function(x) { return x.ev; });
      currentEvents = picked;

      const sel = document.getElementById("eventSelect");
      sel.innerHTML = "";
      if (!picked.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No past events found.";
        sel.appendChild(opt);
        setStatus("No past events found.", false);
        return;
      }
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "— Select job —";
      sel.appendChild(placeholder);

      for (let i = 0; i < picked.length; i++) {
        const ev = picked[i];
        const title = ev.summary || "(no title)";
        const d = extractPrimaryDate(ev);
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = (d ? (d + " – ") : "") + title;
        sel.appendChild(opt);
      }

      setStatus("Loaded last " + picked.length + " past events.", true);
      deriveEmployeeFromCalendarId(calId);

      // Automatically select the most recent and run AI scalp
      if (picked.length > 0) {
        sel.selectedIndex = 1; // first real event
        aiParseSelectedEvent(); // will fall back to basic if no OpenAI key
      }
    }

    function deriveEmployeeFromCalendarId(calId) {
      const employeeInput = document.getElementById("employee");
      if (!calId || employeeInput.value) return;
      if (calId.indexOf("@") === -1) return;
      const local = calId.split("@")[0];
      const parts = local.split(".");
      if (parts.length >= 2) {
        const name = parts.map(function(p) {
          return p.charAt(0).toUpperCase() + p.slice(1);
        }).join(" ");
        employeeInput.value = name;
      }
    }

    // ======================
    //  BASIC (NON-AI) EXTRACTION
    // ======================
    function detectJobTypeFromText(title, desc) {
      const text = (title + " " + desc).toLowerCase();
      if (text.indexOf("tco") !== -1 || text.indexOf("technical call out") !== -1) return "TCO";
      if (text.indexOf("rtf") !== -1 || text.indexOf("return to fix") !== -1) return "RTF";
      if (text.indexOf("recce") !== -1 || text.indexOf("site visit") !== -1 || text.indexOf("survey") !== -1) return "Recce";
      if (text.indexOf("install") !== -1 || text.indexOf("installation") !== -1 || text.indexOf("job/installation") !== -1) return "Job / Installation";
      if (text.indexOf("meeting") !== -1 || text.indexOf("consultation") !== -1 || text.indexOf("consult") !== -1) return "Meeting / Consultation";
      return "";
    }

    function basicJobDescription(summary, description) {
      let lines = [];
      if (summary) lines.push(summary.trim());
      if (description) {
        const descLines = description.split(/\r?\n/);
        const trimmed = [];
        for (let i = 0; i < descLines.length; i++) {
          const l = descLines[i].trim();
          if (!l) continue;
          if (/^\d{4}-\d{2}-\d{2}/.test(l)) continue;
          if (/^\d{2}\/\d{2}\/\d{4}/.test(l)) continue;
          trimmed.push(l);
        }
        for (let j = 0; j < trimmed.length && j < 5; j++) lines.push(trimmed[j]);
      }
      return lines.join("\n");
    }

    function extractTechCheck(description) {
      if (!description) return { summary: "", links: [] };
      const lines = description.split(/\r?\n/);
      const techLines = [];
      const links = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const lower = line.toLowerCase();
        if (lower.indexOf("tech check") !== -1 || lower.indexOf("techcheck") !== -1) {
          techLines.push(line.trim());
        }
        const urlMatch = line.match(/https?:\/\/\S+/g);
        if (urlMatch) {
          for (let k = 0; k < urlMatch.length; k++) {
            const u = urlMatch[k];
            const ul = u.toLowerCase();
            if (ul.indexOf("tech") !== -1 || ul.indexOf("check") !== -1) {
              links.push(u);
            }
          }
        }
      }
      return { summary: techLines.join("\n"), links: links };
    }

    function extractContacts(description) {
      if (!description) return { persons:"", phone:"", email:"" };
      const lines = description.split(/\r?\n/);
      const persons = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const lower = line.toLowerCase();
        if (lower.indexOf("contact:") !== -1 ||
            lower.indexOf("contact -") !== -1 ||
            lower.indexOf("on-site contact") !== -1 ||
            lower.indexOf("onsite contact") !== -1 ||
            lower.indexOf("meeting with") === 0 ||
            lower.indexOf("meet ") === 0) {
          const cleaned = line.replace(/.*:/, "").trim();
          if (cleaned) persons.push(cleaned);
        }
      }
      const emailMatch = description.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
      const phoneMatch = description.match(/\b(?:0\d{9,10}|\+?\d[\d\s\-]{7,}\d)\b/);
      return {
        persons: persons.join(", "),
        phone: phoneMatch ? phoneMatch[0] : "",
        email: emailMatch ? emailMatch[0] : ""
      };
    }

    function fallbackFillFromEvent(ev) {
      const title = ev.summary || "";
      const desc  = ev.description || "";
      const loc   = ev.location || "";

      const jt = detectJobTypeFromText(title, desc);
      const jobTypeSel = document.getElementById("jobType");
      jobTypeSel.value = jt || "";
      updateTimeOnSiteVisibility();

      const dateStr = extractPrimaryDate(ev);
      if (dateStr) document.getElementById("jobDate").value = dateStr;

      // Address/site: prefer location; if none, use title as is
      const addrInput = document.getElementById("jobAddress");
      if (!addrInput.value) {
        if (loc) addrInput.value = loc;
        else if (title) addrInput.value = title;
      }

      document.getElementById("jobDescription").value = basicJobDescription(title, desc);

      const tech = extractTechCheck(desc);
      document.getElementById("techCheck").value = tech.summary || "";
      const techLinksDiv = document.getElementById("techLinks");
      if (tech.links.length) {
        let html = "Tech check links: ";
        for (let i = 0; i < tech.links.length; i++) {
          const u = tech.links[i];
          html += '<a href="' + u + '" target="_blank" rel="noopener">' + u + "</a>";
          if (i < tech.links.length - 1) html += " · ";
        }
        techLinksDiv.innerHTML = html;
      } else {
        techLinksDiv.textContent = "";
      }

      const contacts = extractContacts(desc);
      if (contacts.persons && !document.getElementById("personsMet").value) {
        document.getElementById("personsMet").value = contacts.persons;
      }
      if (contacts.phone && !document.getElementById("contactPhone").value) {
        document.getElementById("contactPhone").value = contacts.phone;
      }
      if (contacts.email && !document.getElementById("contactEmail").value) {
        document.getElementById("contactEmail").value = contacts.email;
      }
    }

    // ======================
    //  TIME ON SITE
    // ======================
    function timeToMinutes(t) {
      if (!t) return null;
      const parts = t.split(":");
      if (parts.length !== 2) return null;
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (isNaN(h) || isNaN(m)) return null;
      return h * 60 + m;
    }

    function minutesToHm(mins) {
      if (mins == null || isNaN(mins)) return "";
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      return h + "h " + String(m).padStart(2, "0") + "m";
    }

    function updateTimeOnSiteVisibility() {
      const jt = document.getElementById("jobType").value;
      const block = document.getElementById("timeOnSiteBlock");
      if (jt === "TCO" || jt === "RTF") {
        block.style.display = "block";
      } else {
        block.style.display = "none";
      }
    }

    function recalcTimeOnSite() {
      const start = timeToMinutes(document.getElementById("timeArrived").value);
      const end   = timeToMinutes(document.getElementById("timeLeft").value);
      let dur = "";
      if (start != null && end != null) {
        let diff = end - start;
        if (diff < 0) diff += 24 * 60;
        dur = minutesToHm(diff);
      }
      document.getElementById("timeDuration").value = dur;
    }

    // ======================
    //  MEDIA LIST
    // ======================
    function updateMediaList() {
      const input = document.getElementById("mediaFiles");
      const listDiv = document.getElementById("mediaList");
      if (!input.files || !input.files.length) {
        listDiv.textContent = "No media selected.";
        return;
      }
      const names = [];
      for (let i = 0; i < input.files.length; i++) {
        const f = input.files[i];
        names.push(f.name + " (" + Math.round(f.size / 1024) + " KB)");
      }
      listDiv.innerHTML = "Attached (" + input.files.length + "):<br>" +
        names.map(function(n) { return "• " + n; }).join("<br>");
    }

    // ======================
    //  TEXT FLUFFING
    // ======================
    function expandNotes(raw) {
      if (!raw) return "";
      const lines = raw.split(/\r?\n/);
      const kept = [];
      for (let i = 0; i < lines.length; i++) {
        const l = lines[i].trim();
        if (l) kept.push(l);
      }
      if (!kept.length) return "";
      const sentences = kept.map(function(line) {
        let s = line;
        if (!/[.!?]$/.test(s)) s += ".";
        s = s.charAt(0).toUpperCase() + s.slice(1);
        return s;
      });
      return sentences.join(" ");
    }

    // ======================
    //  OPENAI AI SCALP
    // ======================
    async function aiParseSelectedEvent() {
      const sel = document.getElementById("eventSelect");
      if (!sel.value) {
        setAiStatus("Select a job from the list.", false);
        return;
      }
      const ev = currentEvents[Number(sel.value)];
      if (!ev) {
        setAiStatus("Selected event not found.", false);
        return;
      }

      const apiKey = localStorage.getItem(OPENAI_KEY_STORAGE);
      const title = ev.summary || "";
      const desc  = ev.description || "";
      const loc   = ev.location || "";
      const start = ev.start || {};
      const end   = ev.end || {};
      const attendees = ev.attendees || [];

      // If no key, use basic extraction and stop.
      if (!apiKey) {
        fallbackFillFromEvent(ev);
        setAiStatus("No OpenAI key set. Used basic extraction only.", false);
        return;
      }

      const eventData = {
        title: title,
        description: desc,
        location: loc,
        start: start,
        end: end,
        attendees: attendees
      };

      const systemPrompt =
        "You are helping an audio-visual company engineer interpret a Google Calendar job event.\n" +
        "You will receive a JSON object with:\n" +
        "- title\n" +
        "- description\n" +
        "- location\n" +
        "- start\n" +
        "- end\n" +
        "- attendees\n\n" +
        "Extract concise, factual information for the job report. Only use what is explicitly in the event fields. " +
        "Do NOT invent sites, people, or details that are not present.\n\n" +
        "Use ALL of title, description and location when looking for addresses, site names and contacts.\n" +
        "For example, if the address or site name appears only in the title or only in the location, still use it.\n\n" +
        "Return STRICT JSON ONLY in this format:\n" +
        "{\n" +
        '  "jobType": "TCO | RTF | Meeting / Consultation | Recce | Job / Installation | \"\"",\n' +
        '  "jobDescription": "1–3 sentence description of what the visit is about, using only details from the event",\n' +
        '  "techCheckSummary": "summary of any TECH CHECK style notes (from description or location), or empty string",\n' +
        '  "personsMet": "names of people expected / met on site if mentioned, comma separated",\n' +
        '  "contactPhone": "phone number if present, else empty string",\n' +
        '  "contactEmail": "email address if present, else empty string",\n' +
        '  "contactAddress": "postal or site address text, if present (from title, description, or location), else empty string",\n' +
        '  "jobDate": "YYYY-MM-DD if obvious from the event start, else empty string",\n' +
        '  "jobAddress": "best guess at the site name/address (from title and/or location), or empty string"\n' +
        "}\n\n" +
        "Rules:\n" +
        "- If you are not sure about a field, return an empty string.\n" +
        "- jobType must be one of the allowed labels or an empty string.\n" +
        "- Do NOT include any explanation, just the JSON object.\n";

      setAiStatus("AI scalping selected event…", true);

      try {
        const res = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            input: [
              { role: "system", content: systemPrompt },
              { role: "user", content: JSON.stringify(eventData) }
            ]
          })
        });

        if (!res.ok) {
          const txt = await res.text().catch(function(){ return ""; });
          console.error("OpenAI error:", res.status, txt);
          setAiStatus("OpenAI error " + res.status + ". Used basic extraction instead.", false);
          fallbackFillFromEvent(ev);
          return;
        }

        const data = await res.json();
        let rawText = "";
        if (data.output &&
            data.output[0] &&
            data.output[0].content &&
            data.output[0].content[0] &&
            data.output[0].content[0].text) {
          rawText = data.output[0].content[0].text;
        }

        let parsed;
        try {
          parsed = JSON.parse(rawText);
        } catch (e) {
          console.error("Failed to parse JSON from OpenAI:", rawText);
          setAiStatus("AI format issue. Used basic extraction instead.", false);
          fallbackFillFromEvent(ev);
          return;
        }

        // Start with basic extraction, then overwrite with AI where present
        fallbackFillFromEvent(ev);

        const jobTypeSel = document.getElementById("jobType");
        if (parsed.jobType) jobTypeSel.value = parsed.jobType;

        if (parsed.jobDescription) {
          document.getElementById("jobDescription").value = parsed.jobDescription;
        }
        if (parsed.techCheckSummary) {
          document.getElementById("techCheck").value = parsed.techCheckSummary;
        }
        if (parsed.personsMet) {
          document.getElementById("personsMet").value = parsed.personsMet;
        }
        if (parsed.contactPhone) {
          document.getElementById("contactPhone").value = parsed.contactPhone;
        }
        if (parsed.contactEmail) {
          document.getElementById("contactEmail").value = parsed.contactEmail;
        }
        if (parsed.contactAddress) {
          document.getElementById("contactAddress").value = parsed.contactAddress;
        }
        if (parsed.jobDate) {
          document.getElementById("jobDate").value = parsed.jobDate;
        } else {
          const dateStr = extractPrimaryDate(ev);
          if (dateStr) document.getElementById("jobDate").value = dateStr;
        }

        const addrInput = document.getElementById("jobAddress");
        if (parsed.jobAddress) {
          addrInput.value = parsed.jobAddress;
        } else if (!addrInput.value) {
          // Fallback: location > title
          if (loc) addrInput.value = loc;
          else if (title) addrInput.value = title;
        }

        updateTimeOnSiteVisibility();
        setAiStatus("AI scalped event and filled fields. Review & tweak as needed.", true);
      } catch (err) {
        console.error(err);
        setAiStatus("Network error talking to OpenAI. Used basic extraction instead.", false);
        fallbackFillFromEvent(ev);
      }
    }

    // ======================
    //  REPORT BUILDING (HTML + TEXT + DOC)
    // ======================
    function buildReportHtmlBody() {
      const employee = document.getElementById("employee").value.trim();
      const jobType  = document.getElementById("jobType").value;
      const jobDate  = document.getElementById("jobDate").value;
      const jobAddr  = document.getElementById("jobAddress").value.trim();
      const jobDesc  = document.getElementById("jobDescription").value.trim();
      const tech     = document.getElementById("techCheck").value.trim();
      const persons  = document.getElementById("personsMet").value.trim();
      const cPhone   = document.getElementById("contactPhone").value.trim();
      const cEmail   = document.getElementById("contactEmail").value.trim();
      const cAddr    = document.getElementById("contactAddress").value.trim();
      const dur      = document.getElementById("timeDuration").value.trim();
      const findings = document.getElementById("findings").value.trim();
      const howRaw   = document.getElementById("howLeft").value.trim();
      const advRaw   = document.getElementById("advisories").value.trim();
      const howFull  = expandNotes(howRaw);
      const advFull  = expandNotes(advRaw);

      const mediaInput = document.getElementById("mediaFiles");
      const mediaItems = [];
      if (mediaInput.files) {
        for (let i = 0; i < mediaInput.files.length; i++) {
          mediaItems.push(mediaInput.files[i].name);
        }
      }

      const title = "Job Report" +
        (jobType ? " – " + jobType : "") +
        (jobDate ? " – " + jobDate : "");

      const header =
        "<h1>" + title + "</h1>" +
        "<table>" +
          "<tr><th style=\"width:20%\">Employee</th><td>" + (employee || "–") + "</td></tr>" +
          "<tr><th>Job type</th><td>" + (jobType || "–") + "</td></tr>" +
          "<tr><th>Date</th><td>" + (jobDate || "–") + "</td></tr>" +
          "<tr><th>Address / site</th><td>" + (jobAddr || "–") + "</td></tr>" +
          "<tr><th>Person(s) met</th><td>" + (persons || "–") + "</td></tr>" +
        "</table>";

      const contactBits = [];
      if (cPhone) contactBits.push("Phone: " + cPhone);
      if (cEmail) contactBits.push("Email: " + cEmail);
      if (cAddr)  contactBits.push("Postal address: " + cAddr.replace(/\n/g, "; "));

      const sections = [];

      sections.push("<h2>Job description</h2>");
      sections.push("<p>" + (jobDesc ? jobDesc.replace(/\n/g, "<br>") : "–") + "</p>");

      sections.push("<h2>Tech check summary</h2>");
      sections.push("<p>" + (tech ? tech.replace(/\n/g, "<br>") : "–") + "</p>");

      sections.push("<h2>Contacts</h2>");
      let contactHtml = "<p><b>Person(s) met:</b> " + (persons || "–") + "</p>";
      if (contactBits.length) contactHtml += "<p>" + contactBits.join("<br>") + "</p>";
      sections.push(contactHtml);

      if (jobType === "TCO" || jobType === "RTF") {
        const arr = document.getElementById("timeArrived").value;
        const left = document.getElementById("timeLeft").value;
        sections.push("<h2>Time on site</h2>");
        sections.push(
          "<p><b>Arrived:</b> " + (arr || "–") +
          "<br><b>Left:</b> " + (left || "–") +
          "<br><b>Duration:</b> " + (dur || "–") + "</p>"
        );
      }

      sections.push("<h2>Findings</h2>");
      sections.push("<p>" + (findings ? findings.replace(/\n/g, "<br>") : "–") + "</p>");

      sections.push("<h2>How things have been left</h2>");
      sections.push("<p>" + (howFull || "–") + "</p>");

      sections.push("<h2>Advisories</h2>");
      sections.push("<p>" + (advFull || "–") + "</p>");

      sections.push("<h2>Photos / videos</h2>");
      if (mediaItems.length) {
        sections.push("<ul>" + mediaItems.map(function(n) { return "<li>" + n + "</li>"; }).join("") + "</ul>");
      } else {
        sections.push("<p>None listed.</p>");
      }

      return header + sections.join("");
    }

    function buildReportDocHtml() {
      const bodyHtml = buildReportHtmlBody();
      const css =
        "<style>" +
        "@page { size: A4; margin: 2cm; }" +
        "body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; }" +
        "h1 { font-size: 16pt; margin: 0 0 6pt 0; }" +
        "h2 { font-size: 13pt; margin: 10pt 0 4pt 0; }" +
        "table { border-collapse: collapse; width: 100%; margin: 4pt 0 10pt 0; }" +
        "th, td { border: 1px solid #cccccc; padding: 4pt 6pt; vertical-align: top; }" +
        "th { background: #f0f0f0; font-weight: bold; }" +
        "p { margin: 0 0 6pt 0; }" +
        "ul { margin: 0 0 6pt 18pt; padding: 0; }" +
        "li { margin: 0 0 2pt 0; }" +
        "</style>";
      return "<!doctype html><html><head><meta charset=\"utf-8\"><title>Job Report</title>" +
             css + "</head><body>" + bodyHtml + "</body></html>";
    }

    function buildReportText() {
      const employee = document.getElementById("employee").value.trim();
      const jobType  = document.getElementById("jobType").value;
      const jobDate  = document.getElementById("jobDate").value;
      const jobAddr  = document.getElementById("jobAddress").value.trim();
      const jobDesc  = document.getElementById("jobDescription").value.trim();
      const tech     = document.getElementById("techCheck").value.trim();
      const persons  = document.getElementById("personsMet").value.trim();
      const cPhone   = document.getElementById("contactPhone").value.trim();
      const cEmail   = document.getElementById("contactEmail").value.trim();
      const cAddr    = document.getElementById("contactAddress").value.trim();
      const dur      = document.getElementById("timeDuration").value.trim();
      const findings = document.getElementById("findings").value.trim();
      const howFull  = expandNotes(document.getElementById("howLeft").value.trim());
      const advFull  = expandNotes(document.getElementById("advisories").value.trim());

      const mediaInput = document.getElementById("mediaFiles");
      const mediaItems = [];
      if (mediaInput.files) {
        for (let i = 0; i < mediaInput.files.length; i++) {
          mediaItems.push(mediaInput.files[i].name);
        }
      }

      const lines = [];
      lines.push("Job Report");
      lines.push("==========");
      lines.push("");
      lines.push("Employee: " + (employee || "-"));
      lines.push("Job type: " + (jobType || "-"));
      lines.push("Date: " + (jobDate || "-"));
      lines.push("");
      lines.push("Site & description");
      lines.push("------------------");
      lines.push("Address/site: " + (jobAddr || "-"));
      lines.push("Job description:");
      lines.push(jobDesc || "-");
      lines.push("");
      lines.push("Tech check summary");
      lines.push("------------------");
      lines.push(tech || "-");
      lines.push("");
      lines.push("Person(s) met & contacts");
      lines.push("------------------------");
      lines.push("Person(s) met: " + (persons || "-"));
      if (cPhone) lines.push("Phone: " + cPhone);
      if (cEmail) lines.push("Email: " + cEmail);
      if (cAddr)  lines.push("Postal address: " + cAddr.replace(/\r?\n/g, "; "));
      lines.push("");

      if (jobType === "TCO" || jobType === "RTF") {
        const arr = document.getElementById("timeArrived").value;
        const left = document.getElementById("timeLeft").value;
        lines.push("Time on site");
        lines.push("------------");
        lines.push("Arrived: " + (arr || "-"));
        lines.push("Left: " + (left || "-"));
        lines.push("Duration: " + (dur || "-"));
        lines.push("");
      }

      lines.push("Findings");
      lines.push("--------");
      lines.push(findings || "-");
      lines.push("");
      lines.push("How things have been left");
      lines.push("-------------------------");
      lines.push(howFull || "-");
      lines.push("");
      lines.push("Advisories");
      lines.push("----------");
      lines.push(advFull || "-");
      lines.push("");

      lines.push("Photos / videos");
      lines.push("---------------");
      if (mediaItems.length) {
        for (let i = 0; i < mediaItems.length; i++) {
          lines.push("• " + mediaItems[i]);
        }
      } else {
        lines.push("None listed.");
      }

      return lines.join("\n");
    }

    function generateReport() {
      const htmlBody = buildReportHtmlBody();
      const text = buildReportText();
      lastReportText = text;
      const preview = document.getElementById("reportPreview");
      preview.innerHTML = htmlBody;
      preview.scrollTop = 0;
    }

    function viewReport() {
      if (!lastReportText) generateReport();
      document.getElementById("reportPreview").scrollIntoView({ behavior: "smooth", block: "start" });
    }

    async function copyReportText() {
      if (!lastReportText) generateReport();
      try {
        await navigator.clipboard.writeText(lastReportText);
        alert("Report text copied to clipboard.");
      } catch (e) {
        alert("Could not copy automatically. You may need to select and copy from the preview.");
      }
    }

    function downloadWordDoc() {
      const html = buildReportDocHtml();
      const jobDate  = document.getElementById("jobDate").value || "";
      const jobType  = document.getElementById("jobType").value || "job";
      const safeType = jobType.replace(/[^a-z0-9]+/gi, "_").toLowerCase();
      const fname = "job_report_" + safeType + (jobDate ? "_" + jobDate : "") + ".doc";
      const blob = new Blob([html], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function sendReportEmail() {
      if (!lastReportText) generateReport();
      const jobType  = document.getElementById("jobType").value || "Job";
      const jobDate  = document.getElementById("jobDate").value || "";
      const jobAddr  = document.getElementById("jobAddress").value.trim();
      const subject  = "Job Report – " + jobType +
                       (jobDate ? (" – " + jobDate) : "") +
                       (jobAddr ? (" – " + jobAddr) : "");
      const to = [
        "Neil.Lovell@audiovisualdirectuk.co.uk",
        "Mark.Thyer@audiovisualdirectuk.co.uk",
        "David.Rolt@audiovisualdirectuk.co.uk"
      ].join(",");

      const body = encodeURIComponent(
        lastReportText +
        "\n\n(Photos/videos and the Word report are not attached automatically – please attach them manually.)"
      );
      const mailto = "mailto:" + encodeURIComponent(to) +
                     "?subject=" + encodeURIComponent(subject) +
                     "&body=" + body;
      window.location.href = mailto;
    }

    // ======================
    //  INIT
    // ======================
    window.addEventListener("DOMContentLoaded", function() {
      // Buttons
      document.getElementById("signinBtn").addEventListener("click", signInManual);
      document.getElementById("mediaFiles").addEventListener("change", updateMediaList);
      document.getElementById("jobType").addEventListener("change", updateTimeOnSiteVisibility);
      document.getElementById("timeArrived").addEventListener("change", recalcTimeOnSite);
      document.getElementById("timeLeft").addEventListener("change", recalcTimeOnSite);
      document.getElementById("generateBtn").addEventListener("click", generateReport);
      document.getElementById("viewBtn").addEventListener("click", viewReport);
      document.getElementById("copyBtn").addEventListener("click", copyReportText);
      document.getElementById("downloadDocBtn").addEventListener("click", downloadWordDoc);
      document.getElementById("sendBtn").addEventListener("click", sendReportEmail);

      const eventSelect = document.getElementById("eventSelect");
      eventSelect.addEventListener("change", function() {
        if (eventSelect.value) aiParseSelectedEvent();
      });

      setStatus("Waiting for Google auth…", true);
      setAiStatus("", true);
    });

    // Try to auto-sign-in & load events as soon as GSI is ready
    window.addEventListener("load", function() {
      try {
        initAuth();
        if (tokenClient) {
          tokenClient.requestAccessToken();
        } else {
          setStatus("Google auth client not ready.", false);
        }
      } catch (e) {
        console.error(e);
        setStatus("Error initialising Google auth.", false);
      }
    });
  </script>
</body>
</html>
